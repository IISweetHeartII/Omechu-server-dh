# .github/workflows/deploy.yml
name: Deploy FoodApp to EC2

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "README.md"
      - "docs/**"
  workflow_dispatch:

env:
  NODE_VERSION: "18"

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check project structure
        run: |
          echo "=== Project Root ==="
          ls -la

          echo "=== Backend Directory ==="
          ls -la backend/ || echo "No backend directory"

          echo "=== Package Files ==="
          find . -name "package.json" -type f || echo "No package.json files found"

      - name: Install backend dependencies
        run: |
          if [ -d "backend" ] && [ -f "backend/package.json" ]; then
            echo "‚úÖ Found backend/package.json"
            cd backend
            echo "Installing dependencies in backend directory..."
            npm install
            echo "‚úÖ Backend dependencies installed"
          else
            echo "‚ùå No backend/package.json found"
            echo "Checking for root package.json..."
            if [ -f "package.json" ]; then
              echo "‚úÖ Found root package.json"
              npm install
            else
              echo "‚ö†Ô∏è No package.json found anywhere - skipping npm install"
            fi
          fi

      - name: Run backend tests
        run: |
          if [ -d "backend" ] && [ -f "backend/package.json" ]; then
            cd backend
            npm test || echo "Tests failed or not configured - continuing"
          else
            echo "No backend directory - skipping tests"
          fi

      - name: Run linter
        run: |
          if [ -d "backend" ] && [ -f "backend/package.json" ]; then
            cd backend
            npm run lint || echo "Linter not configured - continuing"
          else
            echo "No backend directory - skipping linter"
          fi

  deploy:
    needs: test
    runs-on: ubuntu-latest
    name: Deploy to EC2
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - name: Create .env.production from GitHub Secret
        run: echo "${{ secrets.ENV_PRODUCTION }}" > .env.production

      - name: Upload .env.production to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: ".env.production"
          target: "/home/ubuntu/foodapp"

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 300s
          script: |
            # Î≥ÄÏàò ÏÑ§Ï†ï
            PROJECT_DIR="/home/ubuntu/foodapp"
            LOG_FILE="/home/ubuntu/deploy.log"

            # Î°úÍ∑∏ Ìï®Ïàò
            log() {
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
            }

            log "üöÄ Starting deployment process..."

            # ÌîÑÎ°úÏ†ùÌä∏ ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥Îèô
            cd $PROJECT_DIR || {
                log "‚ùå Failed to change directory to $PROJECT_DIR"
                exit 1
            }

            # ÌòÑÏû¨ ÏÉÅÌÉú Î∞±ÏóÖ
            CURRENT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
            log "üìç Current commit: $CURRENT_COMMIT"

            # Git ÏóÖÎç∞Ïù¥Ìä∏
            log "üì• Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main

            NEW_COMMIT=$(git rev-parse --short HEAD)
            log "üìç New commit: $NEW_COMMIT"

            # ÌîÑÎ°úÏ†ùÌä∏ Íµ¨Ï°∞ ÌôïÏù∏
            log "üìÇ Project structure check:"
            ls -la

            if [ -d "backend" ]; then
                log "‚úÖ Backend directory found"
                ls -la backend/
            else
                log "‚ö†Ô∏è No backend directory"
            fi

            # Backend ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
            if [ -d "backend" ] && [ -f "backend/package.json" ]; then
                log "üì¶ Installing backend dependencies..."
                cd backend
                npm install --production || {
                    log "‚ö†Ô∏è npm install failed, but continuing..."
                }
                cd ..
            else
                log "‚ÑπÔ∏è No backend/package.json found, skipping npm install"
            fi

            # ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï
            log "üåç Setting up environment variables..."
            if [ -f .env.production ]; then
              cp .env.production .env
              log "‚úÖ Environment variables copied to .env"
            else
              log "‚ùå .env.production not found in EC2"
              exit 1
            fi

            # Docker Ïª®ÌÖåÏù¥ÎÑà ÌòÑÏû¨ ÏÉÅÌÉú
            log "üê≥ Current Docker containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true

            # Docker Ïª®ÌÖåÏù¥ÎÑà Ïû¨ÏãúÏûë
            log "üîÑ Restarting Docker containers..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml down || true
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

            # ÏÑúÎπÑÏä§ ÏãúÏûë ÎåÄÍ∏∞
            log "‚è≥ Waiting for services to start..."
            sleep 30

            # Ìó¨Ïä§ Ï≤¥ÌÅ¨
            log "üè• Performing health checks..."

            # Ìè¨Ìä∏ 3000 Ï≤¥ÌÅ¨
            if curl -f -s http://localhost:3000/ > /dev/null 2>&1; then
                log "‚úÖ Backend service responding on port 3000"
                BACKEND_OK=true
            else
                log "‚ö†Ô∏è Backend service not responding on port 3000"
                BACKEND_OK=false
            fi

            # Ìè¨Ìä∏ 80 Ï≤¥ÌÅ¨ (Nginx)
            if curl -f -s http://localhost/ > /dev/null 2>&1; then
                log "‚úÖ Nginx service responding on port 80"
                NGINX_OK=true
            else
                log "‚ö†Ô∏è Nginx service not responding on port 80"
                NGINX_OK=false
            fi

            # ÏµúÏ¢Ö ÏÉÅÌÉú ÌôïÏù∏
            log "üìä Final deployment status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

            if [ "$BACKEND_OK" = true ] || [ "$NGINX_OK" = true ]; then
                log "üéâ Deployment completed successfully!"
                log "‚úÖ At least one service is responding"
            else
                log "‚ö†Ô∏è Deployment completed but services may not be fully ready"
                log "üìã Recent container logs:"
                docker-compose logs --tail=10
            fi

            # Ï†ïÎ¶¨
            log "üßπ Cleaning up old Docker images..."
            docker image prune -f > /dev/null 2>&1 || true
            
            log "üßπ Pruning all unused Docker resources including volumes..."
            docker system prune -a --volumes -f > /dev/null 2>&1 || {
            log "‚ö†Ô∏è docker system prune failed"
            }

            log "‚ú® Deployment process finished"
